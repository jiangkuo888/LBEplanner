# 内存优化改进说明

## 问题描述
在使用LBEplanner时，导入OBJ文件、playarea JSON文件并进行动块排布操作后，浏览器会出现"out of memory"错误。

## 主要原因分析
1. **撤销/重做栈无限增长**：每次操作都会保存快照，没有限制栈大小
2. **深拷贝操作频繁**：使用`JSON.parse(JSON.stringify())`进行深拷贝，消耗大量内存
3. **OBJ模型数据重复存储**：每次变换都创建新的模型副本
4. **PIXI.js资源未及时释放**：纹理和图形对象可能没有正确清理

## 解决方案

### 1. 限制撤销栈大小
- 设置最大撤销栈大小为50个快照（提升用户体验）
- 超出限制时自动删除最旧的快照
- 防止内存无限增长

### 2. 优化深拷贝函数
- 只拷贝必要的字段（Name, Index, Points, Entrance, Exit, DeltaYaw, BlockRotateZAxisValue, bShouldRotate）
- 避免循环引用和内存泄漏
- 减少不必要的数据复制

### 3. OBJ模型内存优化
- 缓存原始模型数据，避免重复解析
- 变换时从原始模型重新计算，避免累积误差
- 添加内存清理函数

### 4. 定期内存清理
- 每2分钟自动执行内存清理（减少干扰）
- 每1分钟监控内存使用情况
- 检测到栈过大时强制清理（阈值提高到2倍）

### 5. 手动内存清理
- 在右侧面板添加"清理内存"按钮
- 显示当前内存使用状态
- 用户可以主动清理内存

## 使用方法

### 自动清理
- 系统会自动每2分钟清理一次内存
- 撤销栈超过100个快照时会自动清理

### 手动清理
- 点击右侧面板的"清理内存"按钮
- 查看当前内存使用状态

### 监控信息
- 在浏览器控制台可以看到内存使用情况
- 包括撤销栈大小、重做栈大小等信息

## 预期效果
- 显著减少内存占用
- 避免"out of memory"错误
- 提高应用稳定性
- 支持更长时间的操作会话

## 注意事项
- 撤销栈限制为20个操作，超出后无法撤销更早的操作
- 建议定期手动清理内存
- 如果仍然出现内存问题，可以刷新页面重新开始

## 技术实现
- 使用React hooks管理状态
- 实现智能的内存清理策略
- 添加开发环境的内存监控
- 优化PIXI.js资源管理

