# WebGL动块编辑器项目 PRD

## 一、项目背景与目标

本项目旨在开发一个基于WebGL的可视化编辑器，能够读取`Json/Input/PlayArea_0.json`文件，根据其中的数据动态生成和编辑多边形区域（称为“动块”）。该编辑器将为后续的关卡设计、路径规划等功能提供基础的可视化支持。

## 二、核心功能

1. **数据读取与解析**
   - 读取`Json/Input/PlayArea_0.json`文件。
   - 解析文件中的动块数据，包括多边形顶点、入口、出口、旋转等信息。

2. **动块可视化**
   - 根据每个动块的`Points`字段绘制多边形。
   - 按`Index`编号区分和管理动块。
   - 显示每个动块的`Entrance`（入口）和`Exit`（出口）点。
   - 支持显示`DeltaYaw`（旋转角度），并在可视化时正确应用。
   - 画布自适应所有动块边界，支持手动缩放和重置缩放。

3. **交互与编辑**
   - 支持选择、拖拽、旋转动块。
   - 支持编辑多边形顶点、入口、出口位置（计划中）。
   - 支持保存编辑后的数据为新的JSON文件。

4. **辅助功能**
   - 动块高亮、编号显示。
   - 视图缩放、平移（已支持缩放，平移计划中）。
   - 现代化UI界面（Ant Design美化，功能区与画布分栏）。

## 三、数据结构说明

以`PlayArea_0.json`为例，动块数据结构如下：

```json
{
  "Name": "1-1",           // 动块名称
  "Index": 0,               // 动块编号
  "Points": [               // 多边形顶点数组
    { "Point": { "X": -281.9, "Y": 399.2 } },
    ...
  ],
  "Entrance": {             // 入口点
    "Point": { "X": -179.99, "Y": 549.20 }
  },
  "Exit": {                 // 出口点
    "Point": { "X": -179.99, "Y": 564.20 }
  },
  "DeltaYaw": 0             // 旋转角度（度）
}
```

- `Points`：定义多边形的顶点，顺序连接形成闭合区域。
- `Entrance`/`Exit`：分别为入口和出口的坐标点。
- `DeltaYaw`：该动块的旋转角度，单位为度。

## 四、核心交互流程

1. 启动编辑器 → 选择/自动加载`PlayArea_0.json` → 解析并渲染所有动块（自适应画布）。
2. 用户选择动块 → 显示高亮、编号、入口/出口。
3. 用户编辑动块（拖拽、旋转、编辑顶点/入口/出口）。
4. 用户可手动缩放/重置视图。
5. 保存 → 导出为新的JSON文件。

## 五、技术选型

- 前端框架：React
- 渲染引擎：PixiJS
- UI框架：Ant Design
- 数据处理：TypeScript
- 文件操作：File API

## 六、当前进展与后续计划

- [x] 数据读取与解析
- [x] 动块可视化（多边形、编号、入口/出口、旋转）
- [x] 选择、拖拽、旋转动块
- [x] 编辑后导出JSON
- [x] 动块高亮、编号显示
- [x] 画布自适应、手动缩放、重置缩放
- [x] 现代化UI（Ant Design）
- [x] 画布右键拖拽平移支持全局监听，优化为无限平移，提升用户体验
- [x] 菜单栏美化分区，功能区分组清晰
- [x] 新增入口/出口显示隐藏toggle，默认隐藏
- [x] 选中同幕所有动块时，自动在中心显示大号幕名，并在每个动块上方显示动块名称
- [x] **场地图打点功能**：支持在场地图片上打点、闭合路径、导入导出点位，点位间距数值只随图片缩放变化，闭合后可选中图片并高亮编辑
- [x] **场地图片与动块缩放一致性**：图片和动块均严格叠加viewTransform，缩放、平移、旋转时视觉比例完全一致
- [x] **高亮描边与点位红点**：高亮描边随图片旋转/缩放/平移完全一致，红点不拦截事件，闭合打点体验流畅
- [x] **数值显示与坐标系修正**：点位间距数值只用图片自身坐标，画布缩放不影响数值，显示位置随画布缩放移动
- [x] **打点模式交互优化**：打点未闭合时只能打点，闭合后可选中图片，关闭打点模式自动取消高亮
- [x] **图片操作权限与透明度**：打点模式未开启时图片不可交互且透明度更低，开启后可操作
- [x] **双JSON导入与BlockRotateZAxisValue合并**：支持分别导入playarea.json和PlayAreaBlockData_0.json，仅将BlockRotateZAxisValue合并到动块数据，其他字段不变。
- [x] **BlockRotateZAxisValue旋转同步**：旋转动块时自动同步更新BlockRotateZAxisValue，导出PlayAreaBlockData_0.json时为最新值。
- [x] **导出保持源格式**：导出PlayAreaBlockData_0.json时严格保持导入文件格式，仅同步BlockRotateZAxisValue。
- [x] **动块多选旋转只更新index最小的BlockRotateZAxisValue**：多选旋转时只更新index最小的动块的旋转值。
- [x] **旋转/缩放快捷键统一**：动块和图片旋转均为Q/E（逆/顺时针），缩放为A/D（放大/缩小），长按支持持续操作。
- [x] **误拖动防护**：单击选中动块时，只有鼠标移动超过5px才判定为拖拽，防止误移动。
- [x] **帮助说明与操作区同步**：所有快捷键和交互说明已在界面帮助区和README同步，便于用户查阅。
- [x] 其它细节体验优化与bug修复
- [ ] 兼容旧版动块json格式
- [ ] 人流模拟
- [ ] 撤销/重做

## 七、项目架构与实现分析

### 1. 总体架构
本项目采用前端单页应用（SPA）架构，基于React实现UI与状态管理，PixiJS负责高性能WebGL渲染，Ant Design用于现代化界面布局与交互。所有核心逻辑集中在`src/App.tsx`，无复杂多文件拆分，便于快速迭代。

### 2. 主要技术实现
- **PixiJS渲染**：
  - 通过PixiJS在画布上高效绘制多边形动块、场地图片、辅助网格、锚点等。
  - 支持动块的旋转、拖拽、缩放、批量操作，所有变换均通过PixiJS的图形对象和容器实现。
  - 场地图片与动块严格叠加同一套viewTransform（缩放、平移、旋转），保证视觉一致性。
- **React状态管理**：
  - 使用`useState`、`useRef`、`useEffect`等Hook管理动块数据、选中状态、视图变换、图片状态等。
  - 交互事件（如拖拽、旋转、缩放、打点）均通过React状态驱动PixiJS渲染的更新。
- **Ant Design UI**：
  - 侧边栏（Sider）集成功能开关、数据导入导出、动块层级列表、属性面板等，提升易用性。
  - 使用Switch、Button、List、Card等组件实现分区清晰的操作区。
- **数据导入导出**：
  - 支持JSON文件导入动块数据，自动适配画布视图。
  - 支持导出编辑后的动块数据和场地图点位，便于后续关卡设计与数据流转。
  - 场地图片支持与点位JSON联动导入，兼容新旧格式。

### 3. 关键交互与数据流
- **动块操作**：
  - 支持单选/多选动块，shift多选，批量拖拽、旋转。
  - 选中同一幕所有动块时，自动高亮显示幕名与动块名。
  - 入口/出口点可切换显示，辅助关键信息定位。
- **场地图片与打点**：
  - 支持场地图片的导入、缩放、旋转、拖拽。
  - 打点模式下可在图片上闭合路径，点位数据与图片缩放严格绑定。
  - 点位导入导出支持scale与points，便于数据复用。
- **画布视图控制**：
  - 支持鼠标滚轮缩放、右键拖动画布（全局监听，支持无限平移）。
  - 画布中心锚点、辅助网格始终可见，便于空间定位。
- **数据一致性与兼容性**：
  - 动块数据结构与PRD一致，支持旧版点位JSON兼容。
  - 旋转、拖拽等操作均实时更新数据，导出即所得。

### 4. 代码结构与可扩展性
- 主要业务逻辑集中于`App.tsx`，便于理解和维护。
- 采用TypeScript类型定义动块、点位等核心数据结构，提升类型安全。
- 事件监听与状态变更均通过React Hook实现，易于扩展新功能（如撤销/重做、人流模拟等）。
- 依赖少、结构清晰，适合后续模块化拆分与团队协作。

---

操作说明
1. 动块操作
选择动块
单击动块：选中该动块（默认选中同一幕的所有动块）。
按住Shift键单击：多选/取消多选动块。
侧边栏可通过复选框多选/单选动块。
拖拽动块
鼠标左键按住选中的动块并拖动：移动所有选中的动块。
侧边栏“可以移动单独动块”开关开启时，单选动块可独立拖动。
旋转动块
选中动块后，按Q键：逆时针旋转15°，长按1秒后持续逆时针旋转（每100ms旋转4°）。
选中动块后，按E键：顺时针旋转15°，长按1秒后持续顺时针旋转（每100ms旋转4°）。

缩放视图
鼠标滚轮：以鼠标位置为中心缩放画布。

平移视图
鼠标右键按住画布拖动：平移整个画布。

2. 场地图片与打点
导入场地图片
侧边栏“导入场地参考图”按钮，支持导入CAD或者手绘PNG图片。

开启“场地图打点”开关后：
鼠标左键点击图片：依次打点，闭合后形成路径。
闭合后，点击图片并拖动：移动图片位置。
鼠标滚轮：缩放图片。
Q键：图片逆时针旋转15°。
E键：图片顺时针旋转15°。
A键：按住持续放大图片。
D键：按住持续缩小图片。
Esc键：取消图片选中。

导入/导出地图信息点位
导入图片后会自动弹窗选择同名点位JSON文件（支持新旧格式）。
侧边栏“导出场地图点位”按钮：导出当前点位和图片缩放信息。

3. 动块与数据导入导出
导入playarea.json：导入动块基础数据。
导入PlayAreaBlockData_0.json：仅合并BlockRotateZAxisValue字段。
导出playarea.json：导出原始动块数据。
导出PlayAreaBlockData_0.json：严格保持源文件格式，仅同步BlockRotateZAxisValue。

4. 其它辅助操作
数据导入导出
侧边栏“导入JSON”按钮：导入动块数据。
侧边栏“导出JSON”按钮：导出当前动块数据。

> 本PRD为WebGL动块编辑器的持续迭代文档，后续可根据实际开发和用户反馈持续完善。 